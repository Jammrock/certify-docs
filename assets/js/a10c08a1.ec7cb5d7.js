"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5076],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>m});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},i=Object.keys(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)r=i[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var c=n.createContext({}),s=function(e){var t=n.useContext(c),r=t;return e&&(r="function"==typeof e?e(t):o(o({},t),e)),r},p=function(e){var t=s(e.components);return n.createElement(c.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,i=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=s(r),h=a,m=u["".concat(c,".").concat(h)]||u[h]||d[h]||i;return r?n.createElement(m,o(o({ref:t},p),{},{components:r})):n.createElement(m,o({ref:t},p))}));function m(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=r.length,o=new Array(i);o[0]=h;var l={};for(var c in t)hasOwnProperty.call(t,c)&&(l[c]=t[c]);l.originalType=e,l[u]="string"==typeof e?e:a,o[1]=l;for(var s=2;s<i;s++)o[s]=r[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,r)}h.displayName="MDXCreateElement"},446:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>i,metadata:()=>l,toc:()=>s});var n=r(7462),a=(r(7294),r(3905));const i={id:"azuredns",title:"Using Azure DNS"},o=void 0,l={unversionedId:"dns/providers/azuredns",id:"dns/providers/azuredns",title:"Using Azure DNS",description:"Azure DNS documentation originally written by: Tony Johncock @Tony1044",source:"@site/docs/dns/providers/azuredns.md",sourceDirName:"dns/providers",slug:"/dns/providers/azuredns",permalink:"/docs/dns/providers/azuredns",draft:!1,editUrl:"https://github.com/webprofusion/certify-docs/edit/master/docs/dns/providers/azuredns.md",tags:[],version:"current",frontMatter:{id:"azuredns",title:"Using Azure DNS"}},c={},s=[{value:"Create an Azure AD Service Principle",id:"create-an-azure-ad-service-principle",level:2},{value:"Step 1 \u2013 Install and configure Azure PowerShell",id:"step-1--install-and-configure-azure-powershell",level:2},{value:"Step 2 \u2013 Connect to Azure PS and create the Azure Service Principal and Enterprise Application",id:"step-2--connect-to-azure-ps-and-create-the-azure-service-principal-and-enterprise-application",level:2},{value:"3 - Grant the Application rights to update DNS",id:"3---grant-the-application-rights-to-update-dns",level:2},{value:"4 - Create Service Principal Secret",id:"4---create-service-principal-secret",level:2},{value:"5 \u2013 Retrieve Tenant ID, Subscription ID and Resource Group Name",id:"5--retrieve-tenant-id-subscription-id-and-resource-group-name",level:2},{value:"6 \u2013 Configure Credentials in Certify Certificate Manager",id:"6--configure-credentials-in-certify-certificate-manager",level:2}],p={toc:s},u="wrapper";function d(e){let{components:t,...r}=e;return(0,a.kt)(u,(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"Azure DNS documentation originally written by: Tony Johncock @Tony1044")),(0,a.kt)("p",null,"*","Note: If you have not yet selected a DNS API provider to host your domain with be aware that Azure DNS is currently amongst the most complex to configure for API access. You should also note that ",(0,a.kt)("strong",{parentName:"p"},"Azure Client Secrets can expire, causing your renewals to fail until you replace the key.","*")),(0,a.kt)("h1",{id:"to-configure-using-azure-portal"},"To Configure using Azure Portal"),(0,a.kt)("h2",{id:"create-an-azure-ad-service-principle"},"Create an Azure AD Service Principle"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"In Azure Active Directory, create a user who will then be assigned permissions to update your DNS zone, this can be an App registration. ",(0,a.kt)("strong",{parentName:"li"},"Take note of your Application (client) ID and Directory (tenant) ID.")),(0,a.kt)("li",{parentName:"ul"},"In your DNS Zone, use the Access Control (IAM) option to Add a Role Assignment (DNS Zone Contributor). ",(0,a.kt)("strong",{parentName:"li"},"Take note of your DNS Zone resource-group name and Subscription ID")),(0,a.kt)("li",{parentName:"ul"},'In the app registration user properties, go to Certificates & secrets, Client Secrets > New Client secret. Set a meaningful description such as "Certify The Web DNS updates", and set the preferred expiry (.e.g. 24 Months). When the secret expires the app will fail to make DNS updates, so you need to actively manage this secret and it\'s expiry. ',(0,a.kt)("strong",{parentName:"li"},'Copy the secret "value" for later (the secret "ID" is not used)'))),(0,a.kt)("p",null,"You can now add your Azure DNS credential in the app using the above noted values."),(0,a.kt)("h1",{id:"to-configure-using-powershell"},"To Configure using Powershell"),(0,a.kt)("h2",{id:"step-1--install-and-configure-azure-powershell"},"Step 1 \u2013 Install and configure Azure PowerShell"),(0,a.kt)("p",null,"Follow the instructions here: ",(0,a.kt)("a",{parentName:"p",href:"https://docs.microsoft.com/en-us/powershell/azure/get-started-azureps"},"https://docs.microsoft.com/en-us/powershell/azure/get-started-azureps")),(0,a.kt)("h2",{id:"step-2--connect-to-azure-ps-and-create-the-azure-service-principal-and-enterprise-application"},"Step 2 \u2013 Connect to Azure PS and create the Azure Service Principal and Enterprise Application"),(0,a.kt)("p",null,"From PowerShell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"# Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser\n# Import-Module Az.Accounts\nPS C:\\Users\\Tony> Connect-AzAccount\n")),(0,a.kt)("p",null,"This will launch a web dialog to log into your Azure tenant. Ensure you connect with an account with the relevant administrative credentials in the portal."),(0,a.kt)("p",null,"Pop your password and MFA requirements in as required when prompted."),(0,a.kt)("p",null,"Once connected, create the Application and Service Principal\nRun the following script:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},'$azurePassword = ConvertTo-SecureString "your secure password" -AsPlainText -Force\n\n# Import-Module Az.Resources\n$credentials = New-Object Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential -Property @{ StartDate=Get-Date; EndDate=Get-Date -Year 2024; Password=$azurePassword}\n$MyServicePrincipal = New-AzADServicePrincipal -DisplayName "LetsEncrypt" -PasswordCredential $credentials\n')),(0,a.kt)("p",null,"Once this has successfully run, you need to retrieve the ApplicationID:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"Get-AzADApplication | Select-Object displayname, objectid, applicationid\n")),(0,a.kt)("p",null,"It returns something like the following:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"DisplayName    ObjectId                             ApplicationId\n-----------    --------                             -------------\nLetsEncrypt    7f64adcf-xxxx-yyyy-zzzz-aabbccddeeff aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee\n")),(0,a.kt)("p",null,"Make a note of the ApplicationID"),(0,a.kt)("p",null,"This will have created a service principal and an underlying Azure application."),(0,a.kt)("h2",{id:"3---grant-the-application-rights-to-update-dns"},"3 - Grant the Application rights to update DNS"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Login to portal.azure.com from a web browser"),(0,a.kt)("li",{parentName:"ul"},"Click on your DNS Zone"),(0,a.kt)("li",{parentName:"ul"},"Click on Access Control (IAM)"),(0,a.kt)("li",{parentName:"ul"},"Click on (+) Add"),(0,a.kt)("li",{parentName:"ul"},"Select:",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Role: DNS Zone Contributor"),(0,a.kt)("li",{parentName:"ul"},"Assign access to: Azure AD user, group or application"),(0,a.kt)("li",{parentName:"ul"},"Select: Type in LetsEncrypt"),(0,a.kt)("li",{parentName:"ul"},"Click Save")))),(0,a.kt)("h2",{id:"4---create-service-principal-secret"},"4 - Create Service Principal Secret"),(0,a.kt)("p",null,"From the Azure portal, click Azure Active Directory:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Click App Registrations"),(0,a.kt)("li",{parentName:"ul"},"Click LetsEncrypt"),(0,a.kt)("li",{parentName:"ul"},"Click Certificates & secrets"),(0,a.kt)("li",{parentName:"ul"},"Click Client secrets"),(0,a.kt)("li",{parentName:"ul"},"Click New client secret"),(0,a.kt)("li",{parentName:"ul"},"Type a key description, choose when it will expire (or never \u2013 your choice) and click save.")),(0,a.kt)("p",null,(0,a.kt)("em",{parentName:"p"},"IMPORTANT: The secret is only shown at this point. Copy it as once it\u2019s hidden there is NO way to retrieve it")),(0,a.kt)("h2",{id:"5--retrieve-tenant-id-subscription-id-and-resource-group-name"},"5 \u2013 Retrieve Tenant ID, Subscription ID and Resource Group Name"),(0,a.kt)("p",null,"There are any number of ways to get the tenant ID, but since we\u2019re already in PowerShell:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-powershell"},"Get-AzSubscription\n\nName                     Id                                   TenantId                             State\n----                     --                                   --------                             -----\nSubscription Name        xxxxxxxx-yyyy-zzzz-aaaa-bbbbbbbbbbbb zzzzzzzz-wwww-yyyy-aaaa-bbbbbbbbbbbb Enabled\n")),(0,a.kt)("p",null,"To find your Resource Group Name, browse to your DNS zone in Azure and note the resource group name shown."),(0,a.kt)("h2",{id:"6--configure-credentials-in-certify-certificate-manager"},"6 \u2013 Configure Credentials in Certify Certificate Manager"),(0,a.kt)("p",null,"You now have all the information you require to configure Azure settings in the app."),(0,a.kt)("p",null,"You can add this is a new Stored Credential under Settings or while you are editing a Managed Certificate, under Authorization > DNS."),(0,a.kt)("p",null,'When using the credential as part of DNS validation in the app you will be prompted for the "Zone Id", for Azure DNS this is the DNS zone name, usually in the form of "yourdomain.com"'))}d.isMDXComponent=!0}}]);