"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3684],{3905:(e,t,r)=>{r.d(t,{Zo:()=>p,kt:()=>d});var a=r(7294);function n(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){n(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function o(e,t){if(null==e)return{};var r,a,n=function(e,t){if(null==e)return{};var r,a,n={},i=Object.keys(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||(n[r]=e[r]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)r=i[a],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(n[r]=e[r])}return n}var c=a.createContext({}),l=function(e){var t=a.useContext(c),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},p=function(e){var t=l(e.components);return a.createElement(c.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var r=e.components,n=e.mdxType,i=e.originalType,c=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),u=l(r),h=n,d=u["".concat(c,".").concat(h)]||u[h]||m[h]||i;return r?a.createElement(d,s(s({ref:t},p),{},{components:r})):a.createElement(d,s({ref:t},p))}));function d(e,t){var r=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=r.length,s=new Array(i);s[0]=h;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[u]="string"==typeof e?e:n,s[1]=o;for(var l=2;l<i;l++)s[l]=r[l];return a.createElement.apply(null,s)}return a.createElement.apply(null,r)}h.displayName="MDXCreateElement"},2210:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>s,default:()=>m,frontMatter:()=>i,metadata:()=>o,toc:()=>l});var a=r(7462),n=(r(7294),r(3905));const i={id:"script-hooks",title:"Scripting"},s="Scripting",o={unversionedId:"script-hooks",id:"script-hooks",title:"Scripting",description:"Certify is extensible via PowerShell scripts tasks which can be configured to run before or after the Certificate Request. From v5 onwards these are found under the Tasks tab for your managed certificate. See Tasks for more information.",source:"@site/docs/script-hooks.md",sourceDirName:".",slug:"/script-hooks",permalink:"/docs/script-hooks",draft:!1,editUrl:"https://github.com/webprofusion/certify-docs/edit/master/docs/script-hooks.md",tags:[],version:"current",frontMatter:{id:"script-hooks",title:"Scripting"},sidebar:"docSiderbar",previous:{title:"Deployment Tasks",permalink:"/docs/deployment/tasks_intro"},next:{title:"Using with Apache, nginx or Other Web Servers",permalink:"/docs/guides/apache-nginx"}},c={},l=[{value:"Scripting Basics",id:"scripting-basics",level:2},{value:"Pre-Request Tasks",id:"pre-request-tasks",level:2},{value:"Deployment Tasks (Post-Request)",id:"deployment-tasks-post-request",level:2},{value:"Example: Output the result properties to a text file",id:"example-output-the-result-properties-to-a-text-file",level:3},{value:"Example: Send email via Gmail after unsuccessful renewal",id:"example-send-email-via-gmail-after-unsuccessful-renewal",level:3},{value:"Example: Restart RRAS after successful certificate renewal",id:"example-restart-rras-after-successful-certificate-renewal",level:3},{value:"Example: Convert CNG certificate storage to CSP (for Exchange 2013)",id:"example-convert-cng-certificate-storage-to-csp-for-exchange-2013",level:3},{value:"Example: Enable certificate for Exchange 2013 / 2016 services on local server",id:"example-enable-certificate-for-exchange-2013--2016-services-on-local-server",level:3},{value:"Example: Update VMWare Horizon certificate",id:"example-update-vmware-horizon-certificate",level:3},{value:"Example: Update certificate for SSTP VPN",id:"example-update-certificate-for-sstp-vpn",level:4},{value:"Example: Update SQL Server connection certificate",id:"example-update-sql-server-connection-certificate",level:3},{value:"Example: Update SQL Server Reporting Services",id:"example-update-sql-server-reporting-services",level:3},{value:"Example: Setting private key read permission for a specific account",id:"example-setting-private-key-read-permission-for-a-specific-account",level:3},{value:"Example: Update the certificate on a local WinRM https listener (Windows Admin Center etc)",id:"example-update-the-certificate-on-a-local-winrm-https-listener-windows-admin-center-etc",level:3},{value:"Example: Convert PFX to Java Key Store using keytool",id:"example-convert-pfx-to-java-key-store-using-keytool",level:3},{value:"Example: Deploy to Web Management Service (Web Deploy etc)",id:"example-deploy-to-web-management-service-web-deploy-etc",level:3},{value:"Example: Apply a certificate to the Default FTP SSL Settings in IIS",id:"example-apply-a-certificate-to-the-default-ftp-ssl-settings-in-iis",level:3},{value:"Running In-Process vs Launch New Process",id:"running-in-process-vs-launch-new-process",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2}],p={toc:l},u="wrapper";function m(e){let{components:t,...r}=e;return(0,n.kt)(u,(0,a.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h1",{id:"scripting"},"Scripting"),(0,n.kt)("p",null,"Certify is extensible via PowerShell scripts tasks which can be configured to run before or after the Certificate Request. From v5 onwards these are found under the Tasks tab for your managed certificate. See ",(0,n.kt)("a",{parentName:"p",href:"/docs/deployment/tasks_intro"},"Tasks")," for more information."),(0,n.kt)("p",null,"The scripts are provided a parameter ",(0,n.kt)("inlineCode",{parentName:"p"},"$result")," which contains the status and details of the managed certificate being requested. You can execute any commands including creating new processes, or using other command line tools. "),(0,n.kt)("p",null,"A common use for scripting is to use your new certificate for services other than IIS websites, such as Microsoft Exchange, RDP Gateway, FTP servers and other services. The app also has a range of built-in deployment tasks which also use scripting internally."),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"By default the background service runs as Local System, so your scripts will execute in that context"),", this can be important for issues regarding permissions, file system encryption etc. You can optionally configure your task to run as a specific user if network access or special permissions are required."),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},"Do not store scripts under the C:\\Program Files\\CertifyTheWeb","*"," folder. File stored there will be deleted next time you update the app")),(0,n.kt)("p",null,"All scripts should be refined and tested in a staging environment before use in production."),(0,n.kt)("h2",{id:"scripting-basics"},"Scripting Basics"),(0,n.kt)("p",null,"Here is a sample PowerShell script which demonstrates a few commonly accessed pieces of information:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},'param($result)   # required to access the $result parameter\n\n# either $true or $false\n$result.IsSuccess\n\n# object containing all information Certify has about the saved Site\n$result.ManagedItem\n\n# the IIS (or other service) site ID\n$result.ManagedItem.ServerSiteId   # ex: 1, 2, 3, ...\n\n# the website root directory (if applicable)\n$result.ManagedItem.RequestConfig.WebsiteRootPath   # ex: "C:\\inetpub\\wwwroot"\n\n# the path to the created/renewed certificate PFX file\n$result.ManagedItem.CertificatePath   # ex: "C:\\ProgramData\\Certify\\certes\\assets\\pfx\\00f9e07e-83ca-4029-a173-4b704ee78996.pfx"\n\n# the certificate thumbprint\n$result.ManagedItem.CertificateThumbprintHash # ex: "78b1080a1bf5e7fc0bbb0c0614fc4a18932db5f9"\n\n# the previous certificate thumbprint\n$result.ManagedItem.CertificatePreviousThumbprintHash  # ex: "18c1060a1be5e6fc0bbb0c0614fc4a18932db5fa"\n\n# You can set $result.Abort to $true in a pre-request hook to prevent the certificate from\n# being requested (has no effect in post-request hooks)\n$result.Abort = $false\n')),(0,n.kt)("p",null,"The ",(0,n.kt)("inlineCode",{parentName:"p"},"$result.ManagedItem")," object is an instance of the ",(0,n.kt)("a",{href:"https://github.com/webprofusion/certify/blob/development/src/Certify.Models/Config/ManagedCertificate.cs",target:"_blank"},"ManagedCertificate")," class, so all of the properties it has will be available in your script:"),(0,n.kt)("h2",{id:"pre-request-tasks"},"Pre-Request Tasks"),(0,n.kt)("p",null,"Notes: Pre-request scripts/tasks are executed immediately before the Certificate Request is about to be made (including the challenge file configuration checks)."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("inlineCode",{parentName:"li"},"$result.IsSuccess")," value will always be ",(0,n.kt)("inlineCode",{parentName:"li"},"$false"),"."),(0,n.kt)("li",{parentName:"ul"},"If for some reason your script would like to prevent the Certificate Request from being executed, you may set ",(0,n.kt)("inlineCode",{parentName:"li"},"$result.Abort")," to ",(0,n.kt)("inlineCode",{parentName:"li"},"$true")," and the site your script was executed for will be skipped.")),(0,n.kt)("h2",{id:"deployment-tasks-post-request"},"Deployment Tasks (Post-Request)"),(0,n.kt)("p",null,"Deployment task (post-request) scripts are executed immediately after the Certificate Request was completed, and the certificate was automatically installed and configured according to the site configuration within Certify."),(0,n.kt)("p",null,"By default these run if the request was successful but you can change the task trigger (On Success, On Fail, etc). You can also configure them for manual execution only, so that you can perform them during a maintenance window, or via a windows scheduled task using the command line."),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("inlineCode",{parentName:"li"},"$result.IsSuccess")," value indicates whether or not the Certificate Request was successfully completed."),(0,n.kt)("li",{parentName:"ul"},"The ",(0,n.kt)("inlineCode",{parentName:"li"},"$result.Message")," value provides a message describing the reason for failure, or a message indicating success.")),(0,n.kt)("p",null,"Legacy uses for scripting (v4.x and lower) may have previously included CCS Export, PEM file creation etc however these functions are provided by built-in Deployment Tasks which you should use instead unless the built-in functionality does not meet your requirements."),(0,n.kt)("h3",{id:"example-output-the-result-properties-to-a-text-file"},"Example: Output the result properties to a text file"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},'# Logs results to the given path (modify as required)\n\nparam($result)  \n$logpath = "c:\\temp\\ps-test.txt"\n\n$date = Get-Date\n\nAdd-Content $logpath ("-------------------------------------------------");\nAdd-Content $logpath ("Script Run Date: " + $date)\nAdd-Content $logpath ($result | ConvertTo-Json)\n')),(0,n.kt)("h3",{id:"example-send-email-via-gmail-after-unsuccessful-renewal"},"Example: Send email via Gmail after unsuccessful renewal"),(0,n.kt)("p",null,(0,n.kt)("em",{parentName:"p"},"Note: this is an example only, by default the app will use the certifytheweb.com API to notify you of repeated failures.")),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},'param($result)\nif (!$result.IsSuccess) {\n   $EmailFrom = "username@gmail.com"\n   $EmailTo = "username@gmail.com"\n   $Subject = "Cert Request Failed: " + $result.ManagedItem.RequestConfig.PrimaryDomain\n   $Body = "Error: " + $result.Message\n   $SMTPServer = "smtp.gmail.com"\n   $SMTPClient = New-Object Net.Mail.SmtpClient($SmtpServer, 587)\n   $SMTPClient.EnableSsl = $true\n   $SMTPClient.Credentials = New-Object System.Net.NetworkCredential("username@gmail.com", "password");\n   $SMTPClient.Send($EmailFrom, $EmailTo, $Subject, $Body)\n   write-output "Sent notification email"\n}\n')),(0,n.kt)("h3",{id:"example-restart-rras-after-successful-certificate-renewal"},"Example: Restart RRAS after successful certificate renewal"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},'param($result)\nif ($result.IsSuccess -and $result.ManagedItem.GroupId -eq 1) {\n   write-output "Restarting RRAS..."\n   Net Stop RemoteAccess\n   Net Start RemoteAccess\n   write-output "Done"\n}\n')),(0,n.kt)("h3",{id:"example-convert-cng-certificate-storage-to-csp-for-exchange-2013"},"Example: Convert CNG certificate storage to CSP (for Exchange 2013)"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},'param($result)\n$tempfile = "$env:TEMP\\CertifyTemp.pfx"\n$pfx = get-pfxcertificate -filepath $result.ManagedItem.CertificatePath\ncertutil -f -p Certify -exportpfx $pfx.SerialNumber $tempfile\ncertutil -delstore my $pfx.SerialNumber\ncertutil -p Certify -csp "Microsoft RSA SChannel Cryptographic Provider" -importpfx $tempfile\nremove-item $tempfile\n')),(0,n.kt)("h3",{id:"example-enable-certificate-for-exchange-2013--2016-services-on-local-server"},"Example: Enable certificate for Exchange 2013 / 2016 services on local server"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},"param($result)\nEnable-ExchangeCertificate -Thumbprint $result.ManagedItem.CertificateThumbprintHash -Services POP,IMAP,SMTP,IIS -Force\n")),(0,n.kt)("h3",{id:"example-update-vmware-horizon-certificate"},"Example: Update VMWare Horizon certificate"),(0,n.kt)("p",null,"This example removes any previous certificate with the same FriendlyName (",(0,n.kt)("inlineCode",{parentName:"p"},"vdm"),") then renames the Friendly Name property of the new certificate to ",(0,n.kt)("inlineCode",{parentName:"p"},"vmd"),". It then restarts the ",(0,n.kt)("inlineCode",{parentName:"p"},"wstunnel")," service."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},'param($result)\n\nif ($result.IsSuccess) {\n\n   $thumbprint = $result.ManagedItem.CertificateThumbprintHash # e.g. 2c127d49b4f63d947dd7b91750c9e57751eced0c\n\n   # remove the old cert (by Friendly Name \'vdm\') to avoid duplication, if it exists\n   Get-ChildItem -Path cert:\\LocalMachine\\My | Where {$_.FriendlyName.Equals("vdm")} | Remove-Item\n\n   # rename our new certificate\n   $cert = Get-ChildItem -Path cert:\\LocalMachine\\My\\$thumbprint\n\n   $cert.FriendlyName ="vdm"\n\n   # restart the wstunnel service to apply certificate\n   Restart-Service wstunnel -Force -ErrorAction Stop\n}\n\n')),(0,n.kt)("h4",{id:"example-update-certificate-for-sstp-vpn"},"Example: Update certificate for SSTP VPN"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre",className:"language-PowerShell"},"\n\nparam($result)\n\n# Store certificate in variable\n$cert = Get-ChildItem -Path Cert:\\LocalMachine\\My | Where-Object {$_.Thumbprint -match $result.ManagedItem.CertificateThumbprintHash}\n\n# Stop RRAS, set cert, start RRAS\nImport-Module RemoteAccess\nStop-Service RemoteAccess\nSet-RemoteAccess -SslCertificate $cert\nStart-Service RemoteAccess\n")),(0,n.kt)("h3",{id:"example-update-sql-server-connection-certificate"},"Example: Update SQL Server connection certificate"),(0,n.kt)("p",null,"This example updates the registry key for the SQL Server certificate thumbprint. Note that the instance name will affect the name of the registry key, so you need to find that and change that in the script. Some SQL Server editions may also require the certificate key to be converted to the older RSA SChannel CSP."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"param($result)\n\n# Example script to set SQL Server certificate \n\n# Note that some instances of SQL server may require certificate key storage to use the \"Microsoft RSA SChannel Cryptographic Provider\" \n# See an example conversion: https://docs.certifytheweb.com/docs/script-hooks#example-convert-cng-certificate-storage-to-csp-for-exchange-2013\n\n# See HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\ for the required instance key\n$instanceKey = 'MSSQL15.MSSQLSERVER'  # Change this as required\n\n# -------------------------------------------------------------------------\n\n$registryPath = \"Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Microsoft SQL Server\\$instanceKey\\MSSQLServer\\SuperSocketNetLib\"\n$oldthumbprint = (Get-Itemproperty -Path $registryPath).Certificate\n$newthumbprint = $result.ManagedItem.CertificateThumbprintHash\n\nif ($oldthumb -ne $newthumb) { \n\n  # apply the new certificate thumbprint to the registry key\n  Set-ItemProperty -Path $registryPath -Name 'Certificate' -Value $newthumb\n\n  # optionally restart the SQL service (uncomment if required in this step), correct service name may vary\n  # Restart-Service mssqlserver\n}\n")),(0,n.kt)("h3",{id:"example-update-sql-server-reporting-services"},"Example: Update SQL Server Reporting Services"),(0,n.kt)("p",null,"This is adapted from a community example: ",(0,n.kt)("a",{parentName:"p",href:"https://community.certifytheweb.com/t/sql-server-reporting-services-ssrs/332/7"},"https://community.certifytheweb.com/t/sql-server-reporting-services-ssrs/332/7"),"  "),(0,n.kt)("p",null,"This script gets the report server config object the checks if an existing cert is bound it removes that, then creates the new binding."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'param($result)\n\n$ssrsServerName = "RS_MSSQLSERVER"\n$ssrsReportManagerName = "ReportManager"\n$ssrsReportWebServiceName = "ReportServerWebService"\n\n$httpsPort = 443\n$ipAddress = "0.0.0.0"\n\n# Find the ssrsServerName by running:\n# Get-WmiObject -namespace root\\Microsoft\\SqlServer\\ReportServer -class __Namespace\n# take the value of the name field\n\n$version = (Get-WmiObject \u2013namespace root\\Microsoft\\SqlServer\\ReportServer\\$ssrsServerName  \u2013class __Namespace).Name\n$rsConfig = Get-WmiObject \u2013namespace "root\\Microsoft\\SqlServer\\ReportServer\\$ssrsServerName\\$version\\Admin" -class MSReportServer_ConfigurationSetting\n\n# the cert thumbnail of the newest certificate\n$newthumb = $result.ManagedItem.CertificateThumbprintHash.ToLower()\n\n# check the cert thumbnail of the currently bound certificate (if any)\n\n$oldthumb = \'\'\n\ntry {\n   $oldthumb = $rsConfig.ListSSLCertificateBindings(1033).CertificateHash.Item([array]::LastIndexOf($rsConfig.ListSSLCertificateBindings(1033).Application, $ssrsReportManagerName))\n\n   if ($oldthumb -ne $newthumb) {      \n      $rsConfig.RemoveSSLCertificateBindings($ssrsReportManagerName, $oldthumb, $ipAddress, $httpsport, 1033) \n      $rsConfig.RemoveSSLCertificateBindings($ssrsReportWebServiceName, $oldthumb, $ipAddress, $httpsport, 1033)\n   }\n} catch {}\n\n$rsConfig.CreateSSLCertificateBinding($ssrsReportManagerName, $newthumb, $ipAddress, $httpsport, 1033)\n$rsConfig.CreateSSLCertificateBinding($ssrsReportWebServiceName, $newthumb, $ipAddress, $httpsport, 1033) \n')),(0,n.kt)("h3",{id:"example-setting-private-key-read-permission-for-a-specific-account"},"Example: Setting private key read permission for a specific account"),(0,n.kt)("p",null,"Often you will need to allow a specific user account read permission on a certificate private key to allow a service to use the certificate properly:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'param($result)\n\n## Update the read permission on the certificate private key to allow NT AUTHORITY\\LOCAL_SERVICE (for example) to use the cert (and private key)\n\n# Specify the user, the permissions and the permission type\n$permission = "NT AUTHORITY\\LOCAL SERVICE","Read","Allow"\n\n# get the stored certificate \n$cert = Get-ChildItem -Path cert:\\LocalMachine\\My\\$result.ManagedItem.CertificateThumbprintHash\n\n# configure file system access rule\n$accessRule = New-Object -TypeName System.Security.AccessControl.FileSystemAccessRule -ArgumentList $permission;\n\n# Location of the machine related keys\n$keyPath = $env:ProgramData + "\\Microsoft\\Crypto\\RSA\\MachineKeys\\";\n$keyName = $cert.PrivateKey.CspKeyContainerInfo.UniqueKeyContainerName;\n$keyFullPath = $keyPath + $keyName;\n\ntry\n{\n   # Get the current acl of the private key\n   $acl = (Get-Item $keyFullPath).GetAccessControl(\'Access\');\n   # Add the new ace to the acl of the private key\n   $acl.AddAccessRule($accessRule);\n\n   # Write back the new acl\n   Set-Acl -Path $keyFullPath -AclObject $acl;\n}\ncatch\n{\n   throw $_;\n}\n\n')),(0,n.kt)("h3",{id:"example-update-the-certificate-on-a-local-winrm-https-listener-windows-admin-center-etc"},"Example: Update the certificate on a local WinRM https listener (Windows Admin Center etc)"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"param($result)  \n\n# update the local winrm https listener cert, assumes the cert is already installed to local computer certificate store using Certify\n# based on https://serverfault.com/questions/589607/automatically-reconfigure-winrm-https-listener-with-new-certificate\n \nSet-Location -Path WSMan:\\localhost\\Service\n\nSet-Item -Path .\\CertificateThumbprint -Value $result.ManagedItem.CertificateThumbprintHash\n")),(0,n.kt)("h3",{id:"example-convert-pfx-to-java-key-store-using-keytool"},"Example: Convert PFX to Java Key Store using keytool"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'param($result)  \n\n# adapt paths and passwords as required, assumes keytool is in the system path\n# this examples uses -noprompt to avoid the process hanging on prompts and also redirects output to a single stream otherwise keytool will output to the powershell error stream\n\n# update these parameters as required\n$src_password =""\n$dest_password ="examplepwd"\n$dest_jks_file="C:\\temp\\mykeystore.jks"\n\n\nkeytool -noprompt -importkeystore -srckeystore $result.ManagedItem.CertificatePath -srcstoretype pkcs12 -srcstorepass $src_password -destkeystore $dest_jks_file -deststoretype JKS -deststorepass $dest_password *>&1\n\n')),(0,n.kt)("h3",{id:"example-deploy-to-web-management-service-web-deploy-etc"},"Example: Deploy to Web Management Service (Web Deploy etc)"),(0,n.kt)("p",null,"This example uses netsh to update the certificate bound to port 8172 (Web Deploy etc), it then also sets the (binary) certificate hash in the registry so that the correct certificate is shown in the IIS user interface for the Web Management Service feature."),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"param($result)\n\n$thumb = $result.ManagedItem.CertificateThumbprintHash\n\n# get a new guid:\n$guid = [guid]::NewGuid()\n\n# remove the previous certificate:\n& netsh http delete sslcert ipport=0.0.0.0:8172\n\n# set the current certificate:\n& netsh http add sslcert ipport=0.0.0.0:8172 certhash=$thumb appid=\"{$guid}\"\n\n# Set registry key so Web Management Service UI in IIS matches the new certificate selection\n\n$registryPath =\"HKLM:\\Software\\Microsoft\\WebManagement\\Server\\\"\n$name=\"SslCertificateHash\"\n\n$hexValue= ($thumb -split '(.{2})' -ne '' -replace '^', '0X')\n$binaryHash = ([byte[]] $hexValue)\nNew-ItemProperty -Path $registryPath -Name $name -Value $binaryHash -PropertyType BINARY -Force \n")),(0,n.kt)("h3",{id:"example-apply-a-certificate-to-the-default-ftp-ssl-settings-in-iis"},"Example: Apply a certificate to the Default FTP SSL Settings in IIS"),(0,n.kt)("p",null,"While the app can update a specific FTP site SSL binding for you (select Single Site under Deployment and check in the Preview tab that the ftp binding will be updated) occasionally there may be a requirement to set the global default FTP certificate settings. The following script updates the assigned default FTP certificate in IIS:"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"param($result)\n\n# https://learn.microsoft.com/en-us/iis/configuration/system.applicationhost/sites/sitedefaults/ftpserver/security/ssl\n\n# Set the default FTP SSL certificate hash, this is a global setting and different to setting the certificate for a specific site.\n\n$thumb = $result.ManagedItem.CertificateThumbprintHash\nC:\\Windows\\System32\\inetsrv\\appcmd.exe set config -section:system.applicationHost/sites /siteDefaults.ftpServer.security.ssl.serverCertHash:$thumb /commit:apphost\n")),(0,n.kt)("h2",{id:"running-in-process-vs-launch-new-process"},"Running In-Process vs Launch New Process"),(0,n.kt)("p",null,"The Powershell deployment task can run in two modes on Windows: In-Process and as a New Process. This option mainly affects the process features when the background service is attempting to run the task as an impersonated user. In-Process has very limited user impersonation abilities, New Process has extended Impersonation capabilities but different limitations. "),(0,n.kt)("p",null,"In all cases the background service will attempt to run your task as the user you specify in an impersonation context with a specific Windows ",(0,n.kt)("em",{parentName:"p"},"LogonType"),": ",(0,n.kt)("a",{parentName:"p",href:"https://learn.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types"},"https://learn.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types")," - this affects things like reuse of credentials across network resources and the relevance varies greatly depending on what your script does and which other processes it calls into."),(0,n.kt)("p",null,"In all case you will need to test to determine the best option for your specific script. It is not always possible to get a script to work under impersonation and in those cases you may need to write out the relevant certificate variables like the thumbprint or file path then perform operations separately using your own filewatcher process or a scheduled task elsewhere."),(0,n.kt)("h2",{id:"troubleshooting"},"Troubleshooting"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"In the Certify UI, you may test scripts by clicking the \u25b6 button. You should ideally test scripts after you have completed a successful certificate request so that you have real results and a certificate to work with.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},"The ",(0,n.kt)("inlineCode",{parentName:"p"},"$result.ManagedItem.CertificatePath")," value will be set to the filename (including path) of the PFX file containing the requested certificate, unless the site is new and has not had a successful Certificate Request, in which case the value will not be set.")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("p",{parentName:"li"},'PowerShell Execution Policies may be set by your administrator which affect script execution. The app will try to set the policy to "Unrestricted" by default which may conflict with higher level policy settings. You can set the default script execution policy in the server settings file (then restart the Certify background service) ',(0,n.kt)("inlineCode",{parentName:"p"},"%PROGRAMDATA%\\Certify\\serviceconfig.json")),(0,n.kt)("ul",{parentName:"li"},(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'"PowershellExecutionPolicy":"Unrestricted"')," or"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'"PowershellExecutionPolicy":"Bypass"')," or"),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("inlineCode",{parentName:"li"},'"PowershellExecutionPolicy":""')," (blank string) to use the default policy set by your administrator.")))))}m.isMDXComponent=!0}}]);